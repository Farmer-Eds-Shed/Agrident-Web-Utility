<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agrident Web Utility</title>
  <style>
    :root { --bd:#ddd; --muted:#666; --bg:#f7f7f7; }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; max-width: 1100px; }
    h1 { margin: 0 0 6px; font-size: 44px; line-height: 1.05; }
    .muted { color: var(--muted); font-size: 13px; }
    .card { border: 1px solid var(--bd); border-radius: 12px; padding: 12px; margin: 12px 0; background: #fff; }
    .row { display:flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button, select, input { padding: 10px 12px; font-size: 14px; }
    .pill { padding: 2px 10px; border-radius: 999px; background: #eee; font-size: 12px; white-space: nowrap; }
    .ok { background: #e7f7ea; }
    .bad { background: #ffecec; }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    /* Compact connection card */
    .cardCompact { padding: 10px 12px; }
    .btnRow { display:flex; gap: 8px; width: 100%; }
    .btnRow button { flex: 1; }
    .pillRow { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; width: 100%; }
    .topRow { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; width: 100%; }
    .topRow label { font-size: 13px; color: var(--muted); }
    #connType { min-width: 220px; }

    details.connMore {
      width: 100%;
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    details.connMore > summary {
      cursor: pointer;
      list-style: none;
      user-select: none;
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    details.connMore > summary::-webkit-details-marker { display: none; }
    details.connMore > summary:after {
      content: "▾";
      margin-left: auto;
      color: var(--muted);
      font-size: 12px;
    }
    details.connMore[open] > summary:after { content: "▴"; }
    .connMeta { display:flex; gap: 10px; flex-wrap: wrap; margin-top: 8px; }
    .connMeta span { display:inline-block; }

    /* tables */
    table { width:100%; border-collapse: collapse; min-width: 520px; }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 8px 10px;
      text-align: left;
      font-size: 13px;
      vertical-align: top;
    }
    th { background: #fafafa; position: sticky; top: 0; z-index: 1; }
    .scroll {
      max-height: 260px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:8px;
      margin-top:8px;
      -webkit-overflow-scrolling: touch;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* ---- Modal ---- */
    .overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }
    .overlay.show { display: flex; }
    .modal {
      width: min(900px, 100%);
      max-height: min(80vh, 720px);
      background: #fff;
      border: 1px solid var(--bd);
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modalHeader {
      padding: 12px 14px;
      border-bottom: 1px solid #eee;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .modalTitle { font-weight: 700; }
    .modalSubtitle { color: var(--muted); font-size: 13px; }
    .modalHeaderSpacer { margin-left:auto; }
    .modalBody {
      padding: 12px 14px;
      overflow: auto;
      overflow-x: hidden; /* important: prevent sideways scroll */
    }

    /* NEW: field grid (2-up) */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      align-items: start;
    }
    .field{
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0; /* allow shrink */
    }
    .field label{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .field input{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 14px;
      min-width: 0; /* allow shrink */
      box-sizing: border-box;
    }

    .modalFooter {
      padding: 12px 14px;
      border-top: 1px solid #eee;
      display:flex; gap:10px; justify-content: flex-end;
      background: #fafafa;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
    }
    .btnPrimary {
      border-color: #0b6;
      background: #0b6;
      color: #fff;
    }
    .btnDanger {
      border-color: #d33;
      background: #d33;
      color: #fff;
    }
    .btnSmall {
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 10px;
      line-height: 1.1;
    }

    /* --- Mobile improvements --- */
    @media (max-width: 640px) {
      #connTypeRow { display: none; }
      body { margin: 12px; }
      h1 { font-size: 30px; }
      .card { padding: 10px; margin: 10px 0; }
      .cardCompact { padding: 10px; }

      .row { flex-direction: column; align-items: stretch; }
      .row > * { width: 100%; }

      /* keep connection buttons 2-up */
      .btnRow { flex-direction: row; }
      .btnRow button { width: auto; }

      .topRow { flex-direction: column; align-items: stretch; }
      #connType { width: 100%; }

      .pillRow { flex-direction: row; width: 100%; }
      .pill { width: fit-content; }

      button, select, input { width: 100%; }
      #taskSelect { width: 100%; }

      .scroll { max-height: 360px; }

      /* modal grid becomes single column */
      .grid{ grid-template-columns: 1fr; }

      .modalFooter { justify-content: stretch; }
      .modalFooter button { width: 100%; }

      table { min-width: 680px; }
    }
  </style>
</head>

<body>
  <h1>Agrident Web Utility</h1>
  <div class="muted">Agrident/Allflex Data Downloader</div>

  <!-- Connection / Status -->
  <div class="card cardCompact" id="connCard">
    <div class="topRow" id="connTypeRow">
      <label for="connType">Connection:</label>
      <select id="connType">
        <option value="ble">Bluetooth (BLE)</option>
        <option value="serial">USB Serial (COM)</option>
      </select>
      <span class="muted" id="connHint" style="margin-left:auto;"></span>
    </div>

    <div class="btnRow" style="margin-top:8px;">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>

    <div class="pillRow" style="margin-top:8px;">
      <span id="status" class="pill bad">Disconnected</span>
      <span id="busy" class="pill">idle</span>
    </div>

    <details id="connMore" class="connMore">
      <summary>Connection details</summary>
      <div class="connMeta">
        <span class="muted" id="deviceName"></span>
        <span class="muted" id="syncedAt"></span>
      </div>
    </details>
  </div>

  
  <!-- Tabs: Tasks / Groups -->
  <div class="card">
    <div class="row" style="gap:10px; margin-bottom:10px;">
      <button class="btn btnSmall" id="tabGroupsBtn" type="button">Groups</button>
      <button class="btn btnSmall btnPrimary" id="tabTasksBtn" type="button">Tasks</button>
      <span class="muted" style="margin-left:auto;" id="activeTabHint">Tasks</span>
    </div>

    <!-- Tasks panel -->
    <div id="panelTasks">
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <button class="btn btnSmall" id="syncTasksBtn" disabled>Sync Tasks</button>
        
        <label class="muted" for="taskSelect">Task:</label>
        <select id="taskSelect" disabled>
          <option value="">(connect to load tasks)</option>
        </select>
        <button id="downloadCsvBtn" disabled>Download CSV</button>
        
      </div>

      <h3 style="margin:0 0 6px;">Preview</h3>
      <div class="muted" id="previewMeta">No task selected.</div>

      <div class="scroll" style="max-height: 320px;">
        <table>
          <thead><tr id="previewHead"></tr></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Groups panel -->
    <div id="panelGroups" style="display:none;">
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <button class="btn btnSmall" id="syncGroupsBtn" disabled>Sync Groups</button>

        <label class="muted" for="groupSelect">Group:</label>
        <select id="groupSelect" disabled>
          <option value="">(sync groups)</option>
        </select>

        <label class="muted" style="display:flex; align-items:center; gap:6px;">
          <input type="checkbox" id="preferGroupX" checked />
          Prefer XGGROUPX (weight)
        </label>

        <button id="downloadGroupCsvBtn" disabled>Download Group CSV</button>
      </div>

      <h3 style="margin:0 0 6px;">Preview</h3>
      <div class="muted" id="groupPreviewMeta">No group selected.</div>

      <div class="scroll" style="max-height: 320px;">
        <table>
          <thead><tr id="groupPreviewHead"></tr></thead>
          <tbody id="groupPreviewBody"></tbody>
        </table>
      </div>

      <div class="muted" id="groupsSyncedAt" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Modal editor -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Edit Row</div>
        <span class="modalSubtitle" id="modalSubtitle"></span>
        <span class="modalHeaderSpacer"></span>
        <button class="btn btnSmall" id="modalCloseBtn" title="Close">✕</button>
      </div>

      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          Tip: Date columns accept <code>08022026</code>, <code>08-02-26</code>, <code>2026-02-08</code> and will export as <code>dd/mm/yyyy</code>.
        </div>
        <div id="modalGrid" class="grid"></div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="modalCancelBtn">Cancel</button>
        <button class="btn btnDanger" id="modalDeleteBtn">Delete Row</button>
        <button class="btn btnPrimary" id="modalSaveBtn">Save</button>
      </div>
    </div>
  </div>

<script type="module" src="./app.js"></script>
</body>
</html>