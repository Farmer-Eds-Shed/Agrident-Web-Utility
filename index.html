<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Agrident Web Utility</title>
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <header class="appHeader">
    <div class="appTitleWrap">
      <h1 class="appTitle">Agrident Web Utility</h1>
      <div class="muted appSubtitle">Agrident/Allflex Data Downloader</div>
    </div>
  </header>

  <!-- Connection / Status -->
  <div class="card cardCompact" id="connCard">
    <div class="topRow" id="connTypeRow">
      <label for="connType">Connection:</label>
      <select id="connType">
        <option value="ble">Bluetooth (BLE)</option>
        <option value="serial">USB Serial (COM)</option>
      </select>
      <span class="muted mlAuto" id="connHint"></span>
    </div>

    <div class="connLiveRow mt8" id="connLiveRow" aria-live="polite">
      <div class="connLeft">
        <span id="status" class="pill bad">Disconnected</span>
        <span id="busy" class="pill">idle</span>
      </div>

      <div class="connRight">
        <button id="connectBtn" class="btn btnPrimary">Connect</button>
        <button id="disconnectBtn" class="btn btnDanger" disabled title="Disconnect">Disconnect</button>
      </div>
    </div>

    <details id="connMore" class="connMore">
      <summary>Connection details</summary>
      <div class="connMeta">
        <span class="muted" id="deviceName"></span>
        <span class="muted" id="syncedAt"></span>
      </div>
    </details>
  </div>

  <!-- Tabs / Navigation -->
  <nav class="tabBar" aria-label="Sections">
    <div class="tabBarInner">
      <button class="btn tabBtn active" id="tabGroupsBtn" type="button">
        <span class="tabIcon" aria-hidden="true">üë•</span>
        <span class="tabLabel">Groups</span>
      </button>
      <button class="btn tabBtn" id="tabTasksBtn" type="button">
        <span class="tabIcon" aria-hidden="true">üßæ</span>
        <span class="tabLabel">Tasks</span>
      </button>
      <button class="btn tabBtn" id="tabTaglistBtn" type="button">
        <span class="tabIcon" aria-hidden="true">üè∑Ô∏è</span>
        <span class="tabLabel">Taglist</span>
      </button>
      <button class="btn tabBtn" id="tabSettingsBtn" type="button">
        <span class="tabIcon" aria-hidden="true">‚öôÔ∏è</span>
        <span class="tabLabel">Settings</span>
      </button>

      <span class="muted tabHint" id="activeTabHint">Groups</span>
    </div>
  </nav>

  <main class="appMain">

    <!-- Groups panel -->
    <section id="panelGroups" class="card panelCard">
      <div class="toolbar">
        <div class="toolbarPrimary">
          <button class="btn btnPrimary" id="syncGroupsBtn" disabled>Get Groups</button>
          <button class="btn" id="downloadGroupCsvBtn" disabled>Download CSV</button>
        </div>

        <!-- Controls row: dropdown + search side-by-side on mobile -->
        <div class="toolbarControls">
          <div class="fieldInline">
            <label class="muted" for="groupSelect">Group</label>
            <select id="groupSelect" disabled>
              <option value="">(Get groups)</option>
            </select>
          </div>

          <div class="fieldInline">
            <label class="muted" for="groupFilter">Search</label>
            <input id="groupFilter" type="text" placeholder="Search‚Ä¶" disabled>
          </div>

          <!-- Checkbox moved INTO the controls row so it can span both columns on mobile -->
          <label class="muted inlineCheck controlSpan2">
            <input type="checkbox" id="preferGroupX" checked />
            EID + Weight
          </label>
        </div>
      </div>

      <div class="panelHeader">
        <h3 class="mb6">Preview</h3>
        <div class="muted" id="groupPreviewMeta">No group selected.</div>
      </div>

      <div class="scroll scrollTall">
        <table>
          <thead><tr id="groupPreviewHead"></tr></thead>
          <tbody id="groupPreviewBody"></tbody>
        </table>
      </div>

      <div class="muted mt8" id="groupsSyncedAt"></div>
    </section>

    <!-- Tasks panel -->
    <section id="panelTasks" class="card panelCard" style="display:none;">
      <div class="toolbar">
        <div class="toolbarPrimary">
          <button class="btn btnPrimary" id="syncTasksBtn" disabled>Get Tasks</button>
          <button class="btn" id="downloadCsvBtn" disabled>Download CSV</button>
        </div>

        <div class="toolbarControls">
          <div class="fieldInline">
            <label class="muted" for="taskSelect">Task</label>
            <select id="taskSelect" disabled>
              <option value="">(connect to load tasks)</option>
            </select>
          </div>

          <div class="fieldInline">
            <label class="muted" for="taskFilter">Search</label>
            <input id="taskFilter" type="text" placeholder="Search‚Ä¶" disabled>
          </div>
        </div>
      </div>

      <div class="panelHeader">
        <h3 class="mb6">Preview</h3>
        <div class="muted" id="previewMeta">No task selected.</div>
      </div>

      <div class="scroll scrollTall">
        <table>
          <thead><tr id="previewHead"></tr></thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Taglist & Alerts panel -->
    <section id="panelTaglist" class="panelCard" style="display:none;">
      <!-- Taglist -->
      <div class="card">
        <div class="toolbar">
          <div class="toolbarPrimary">
            <button class="btn btnPrimary" id="syncTaglistBtn" disabled>Sync Device</button>
            <button class="btn" id="useDeviceAsDraftBtn" disabled>Use Device as Draft</button>
            <button class="btn btnDanger" id="eraseTaglistBtn" disabled>Erase Device Taglist</button>
          </div>

          <div class="toolbarControls">
            <div class="fieldInline">
              <label class="muted" for="taglistUploadMode">Upload mode</label>
              <select id="taglistUploadMode" disabled>
                <option value="append" selected>Append</option>
                <option value="replace">Replace (erase then upload)</option>
              </select>
            </div>

            <div class="fieldInline">
              <label class="muted" for="taglistFilter">Filter</label>
              <input id="taglistFilter" type="text" placeholder="Filter draft‚Ä¶" disabled>
            </div>
          </div>

          <div class="toolbarControls toolbarControlsWide">
            <div class="fieldInline">
              <label class="muted" for="taglistFile">Load CSV as Draft</label>
              <input id="taglistFile" type="file" accept=".csv,text/csv" disabled>
            </div>
          </div>

          <div class="toolbarSecondary">
            <button class="btn" id="downloadTaglistCsvBtn" disabled>Export Draft CSV</button>
            <button class="btn" id="addTagRowBtn" disabled>Add Row</button>
            <button class="btn btnPrimary" id="uploadTaglistBtn" disabled>Upload Draft ‚Üí Wand</button>
          </div>
        </div>

        <div class="muted" id="taglistMeta">Taglist ‚Äî not loaded.</div>

        <div class="scroll scrollTall">
          <table>
            <thead><tr id="taglistHead"></tr></thead>
            <tbody id="taglistBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Alerts -->
      <div class="card">
        <div class="toolbar">
          <div class="toolbarPrimary">
            <button class="btn btnPrimary" id="syncAlertsBtn" disabled>Sync Device</button>
            <button class="btn" id="useAlertsAsDraftBtn" disabled>Use Device as Draft</button>
            <button class="btn btnDanger" id="eraseAlertsBtn" disabled>Erase Device Alerts</button>
          </div>

          <div class="toolbarControls">
            <div class="fieldInline">
              <label class="muted" for="alertsUploadMode">Upload mode</label>
              <select id="alertsUploadMode" disabled>
                <option value="append" selected>Append</option>
                <option value="replace">Replace (erase then upload)</option>
              </select>
            </div>

            <div class="fieldInline">
              <label class="muted" for="alertsFilter">Filter</label>
              <input id="alertsFilter" type="text" placeholder="Filter draft‚Ä¶" disabled>
            </div>
          </div>

          <div class="toolbarControls toolbarControlsWide">
            <div class="fieldInline">
              <label class="muted" for="alertsFile">Load CSV as Draft</label>
              <input id="alertsFile" type="file" accept=".csv,text/csv" disabled>
            </div>
          </div>

          <div class="toolbarSecondary">
            <button class="btn" id="downloadAlertsCsvBtn" disabled>Export Draft CSV</button>
            <button class="btn" id="addAlertRowBtn" disabled>Add Row</button>
            <button class="btn btnPrimary" id="uploadAlertsBtn" disabled>Upload Draft ‚Üí Wand</button>
          </div>
        </div>

        <div class="muted" id="alertsMeta">Alerts ‚Äî not loaded.</div>

        <div class="scroll scrollTall">
          <table>
            <thead><tr id="alertsHead"></tr></thead>
            <tbody id="alertsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Settings panel -->
    <section id="panelSettings" class="panelCard" style="display:none;">
      <div class="card">
        <div class="toolbar">
          <div class="toolbarPrimary">
            <button class="btn btnPrimary" id="syncSettingsBtn" disabled>Sync Device</button>
            <button class="btn" id="useSettingsAsDraftBtn" disabled>Use Device as Draft</button>
          </div>

          <div class="toolbarControls">
            <div class="fieldInline">
              <label class="muted" for="settingsFilter">Filter</label>
              <input id="settingsFilter" type="text" placeholder="Filter draft‚Ä¶" disabled>
            </div>

            <div class="fieldInline">
              <label class="muted" for="settingsFile">Load JSON as Draft</label>
              <input id="settingsFile" type="file" accept=".json,application/json" disabled>
            </div>
          </div>

          <div class="toolbarSecondary">
            <button class="btn" id="downloadSettingsBtn" disabled>Export Draft JSON</button>
            <button class="btn" id="addSettingRowBtn" disabled>Add Row</button>
            <button class="btn btnPrimary" id="uploadSettingsBtn" disabled>Upload Draft ‚Üí Wand</button>
          </div>
        </div>

        <div class="muted" id="settingsMeta">Settings ‚Äî not loaded.</div>

        <div class="scroll scrollTall">
          <table>
            <thead><tr id="settingsHead"></tr></thead>
            <tbody id="settingsBody"></tbody>
          </table>
        </div>

        <div class="muted mt8" id="settingsInfo"></div>
      </div>
    </section>

  </main>

  <!-- Modal editor -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">Edit Row</div>
        <span class="modalSubtitle" id="modalSubtitle"></span>
        <span class="modalHeaderSpacer"></span>
        <button class="btn btnSmall" id="modalCloseBtn" title="Close">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="muted" style="margin-bottom:10px;">
          Tip: Date columns accept <code>08022026</code>, <code>08-02-26</code>, <code>2026-02-08</code> and will export as <code>dd/mm/yyyy</code>.
        </div>
        <div id="modalGrid" class="grid"></div>
      </div>

      <div class="modalFooter">
        <button class="btn" id="modalCancelBtn">Cancel</button>
        <button class="btn btnDanger" id="modalDeleteBtn">Delete Row</button>
        <button class="btn btnPrimary" id="modalSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Tiny UI helper: auto-collapse connection card when connected + keep tab "active" state -->
  <script>
    (function () {
      const connCard = document.getElementById("connCard");
      const statusEl = document.getElementById("status");
      const hint = document.getElementById("activeTabHint");
      const tabBtns = {
        groups: document.getElementById("tabGroupsBtn"),
        tasks: document.getElementById("tabTasksBtn"),
        taglist: document.getElementById("tabTaglistBtn"),
        settings: document.getElementById("tabSettingsBtn"),
      };

      function updateConnCollapsed() {
        const connected = statusEl && !statusEl.classList.contains("bad") && /connected/i.test(statusEl.textContent || "");
        connCard && connCard.classList.toggle("connected", !!connected);
      }

      function updateActiveTabBtn() {
        const panels = [
          ["groups", document.getElementById("panelGroups")],
          ["tasks", document.getElementById("panelTasks")],
          ["taglist", document.getElementById("panelTaglist")],
          ["settings", document.getElementById("panelSettings")],
        ];

        const active = panels.find(([, el]) => el && el.style.display !== "none");
        const key = active ? active[0] : "groups";

        Object.entries(tabBtns).forEach(([k, b]) => {
          if (!b) return;
          b.classList.toggle("active", k === key);
        });

        if (hint) hint.textContent = key.charAt(0).toUpperCase() + key.slice(1);
      }

      if (statusEl) {
        const obs = new MutationObserver(() => updateConnCollapsed());
        obs.observe(statusEl, { attributes: true, childList: true, subtree: true, characterData: true });
      }
      updateConnCollapsed();

      const panelObs = new MutationObserver(() => updateActiveTabBtn());
      ["panelGroups","panelTasks","panelTaglist","panelSettings"].forEach(id => {
        const el = document.getElementById(id);
        if (el) panelObs.observe(el, { attributes: true, attributeFilter: ["style","class"] });
      });
      updateActiveTabBtn();
    })();
  </script>

  <script type="module" src="./app.js"></script>
</body>
</html>
